# Webアプリ仕様書（簡易）

この文書は、日記・予定を管理する簡易Webアプリの仕様書です。主にDynamoDBのテーブル定義を中心に記載しています。

## 目的
- SNS風のタイムライン形式で日記や予定を記録する。
- 日記（単日）と予定（期間）を同一の日付レコードに格納し、レコード数を削減する（1日1レコード方針は維持）。
- ハッシュタグを用いて投稿を分類・フィルタリングする。
- データ構造はActivityPubに準拠する。
- 本文はクライアント側で暗号化（4桁PIN）して保存する。

## システム概要
- フロントエンド: React（Vite）
- バックエンド: AWS Lambda（API Gateway 経由）
- 認証: Amazon Cognito
- データストア: Amazon DynamoDB（オンデマンド）

## DynamoDB テーブル定義

### テーブル名
- `KakuyasuTimelineDiary`

### パーティション/ソートキー
- `pk` (String): `USER#{userId}#YEAR#{YYYY}`
- `sk` (String): `DATE#{YYYY-MM-DD}`

### レコード構造（1日1レコード - ActivityPub OrderedCollection）
1日のデータを `OrderedCollection` として保存します。

| 属性名 | 型 | 説明 |
| --- | --- | --- |
| pk | String | ユーザー + 年単位のパーティション |
| sk | String | 日付単位のソートキー |
| userId | String | Cognito sub |
| orderedItems | List\<Map> | アクティビティ（投稿）のリスト |

#### orderedItems の要素（ActivityPub Object）
日記や予定はハッシュタグ（`#日記` / `#予定`）で区別します。

**共通フィールド:**
| 属性名 | 型 | 説明 |
| --- | --- | --- |
| id | String | UUID |
| content | String | 暗号化済み本文 |
| name | String | 暗号化済みタイトル（任意） |
| published | String | ISO8601日時 |
| tag | List\<Map> | ハッシュタグ |

**tag の要素:**
| 属性名 | 型 | 説明 |
| --- | --- | --- |
| type | String | `Hashtag` |
| name | String | タグ名（例: `#旅行`） |

**予定（`#予定`）固有フィールド:**
| 属性名 | 型 | 説明 |
| --- | --- | --- |
| startTime | String | ISO8601日時 |
| endTime | String | ISO8601日時 |

### サンプル（DynamoDB出力例）
```json
{
  "pk": "USER#c744...#YEAR#2025",
  "sk": "DATE#2025-12-20",
  "userId": "c744...",
  "orderedItems": [
    {
      "id": "uuid-1",
      "content": "EncryptedContent...",
      "published": "2025-12-20T10:00:00Z",
      "tag": [
        { "type": "Hashtag", "name": "#日記" },
        { "type": "Hashtag", "name": "#ランチ" }
      ]
    },
    {
      "id": "uuid-2",
      "name": "EncryptedTitle...",
      "startTime": "2025-12-20T13:00:00Z",
      "endTime": "2025-12-20T15:00:00Z",
      "tag": [
        { "type": "Hashtag", "name": "#予定" },
        { "type": "Hashtag", "name": "#会議" }
      ]
    }
  ]
}
```

## データ登録ルール
- 投稿:
  - 対象日付のレコード（`OrderedCollection`）を取得。
  - `orderedItems` に新しいオブジェクトを追加して更新。
  - 予定（Event）が複数日にまたがる場合、開始日のレコードに保存するか、各日のレコードに保存するかは実装依存（今回はシンプルに開始日、または各日にコピーする方針とする。※検索のしやすさを考慮し、表示上の日付に紐づくようにする）

## API 仕様（概要）

### GET /items
- クエリ: `year`, `month`
- 戻り値: 指定年月の日付レコード配列（ActivityPub OrderedCollectionのリスト）

### POST /items
- 投稿作成:
  - Body: ActivityPub Object（`startTime` または `published` を含む）
  - サーバー側で `published` または `startTime` の日付から保存先の `pk`, `sk` を決定し、`orderedItems` に追加。

### DELETE /items/{id}
- 削除:
  - クエリ: `date`, `itemId`
  - 指定日の `orderedItems` から該当IDのアイテムを削除。

## 画面仕様
- タイムライン表示:
  - 取得した `OrderedCollection` を展開し、時系列（`published` / `startTime`）順に表示。
  - ハッシュタグによるフィルタリング機能。
- 投稿フォーム:
  - テキスト入力、ハッシュタグ入力、日付/時間指定。
  - 暗号化して送信。

## 暗号化仕様
- 変更なし（AES-GCM, PBKDF2）
