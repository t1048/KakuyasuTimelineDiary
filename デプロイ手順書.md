# 📘 激安日記アプリ 開発・運用手順書（完全版）

この手順書は、\*\*「最小コスト」**かつ**「全自動」\*\*で自分専用のアプリを運用するためのガイドです。

## ✅ 前提（最初に1回だけ確認）

- AWSアカウントを作成済みであること
- ローカルに以下が入っていること
  - AWS CLI（`aws --version`）
  - Node.js（CDK CLI / フロントビルド用）
  - Python（CDKアプリ実行用 / 本プロジェクトは `python3.11` を使用）
  - AWS CDK CLI（`cdk --version`）
- AWS認証情報が設定済みであること（例：`aws configure` または `AWS_PROFILE`）

> `cdk deploy` の実行ユーザーには、CloudFormation / IAM / S3 / CloudFront / Lambda / API Gateway / DynamoDB / Cognito 等の作成権限が必要です。

## 🧰 ローカルセットアップ（初回のみ）

CDK側（Python）の依存関係を準備します。

Bash

```
cd gekiyasu-diary-cdk-py

# 仮想環境（未作成の場合のみ）
python -m venv .venv

# 有効化（Windows の場合は `.venv\\Scripts\\activate.bat`）
source .venv/bin/activate

pip install -r requirements.txt
```

## 🧭 アカウント/リージョン/プロファイルについて

- 利用する認証情報は `AWS_PROFILE`（任意）と AWS CLI の設定に従います
- CDK は実行時に `CDK_DEFAULT_ACCOUNT` / `CDK_DEFAULT_REGION` を自動解決します（`app.py` で利用）

Bash

```
# どのアカウントで実行されるか確認
aws sts get-caller-identity

# プロファイルを使う例（bootstrap / deploy どちらにも使えます）
AWS_PROFILE=your-profile cdk deploy
```

## ✅ デプロイ前チェック（任意）

Bash

```
cd gekiyasu-diary-cdk-py
cdk ls
cdk diff
```

## 🏁 【初回のみ】地鎮祭と2段階デプロイ

一番最初だけ、AWS環境の準備とURL確定のために以下の手順を踏みます。

### Step 0: AWS環境の地鎮祭（Bootstrap）

CDKを動かすための専用資材置き場をAWS上に作成します。これを行わないとデプロイでエラーになります。

Bash

```
cd gekiyasu-diary-cdk-py

# 例：デフォルトの認証情報で実行（推奨：アカウント/リージョンを明示）
cdk bootstrap aws://ACCOUNT_ID/ap-northeast-1

# 例：プロファイル指定で実行したい場合
# AWS_PROFILE=your-profile cdk bootstrap aws://ACCOUNT_ID/ap-northeast-1
```

> ※ `cdk bootstrap` は「1つのアカウント × 1つのリージョン」につき**一度だけ**でOKです（リージョンを変える場合はそのリージョンでも実行）。

### Step 1: インフラの器を作る（1回目のデプロイ）

まずはAPI Gatewayを作成し、URLを発行させます。この時点ではReactアプリの中身（`dist`フォルダ）がなくても大丈夫なようにCDKを組んでいます。

Bash

```
# インフラだけを先にデプロイ
cdk deploy

# IAM変更の確認プロンプトを省略したい場合
# cdk deploy --require-approval never
```

### Step 2: URLを収穫して埋め込む

デプロイ完了後に表示される `Outputs` からAPIのURLをコピーします。

Plaintext

```
Outputs:
KakuyasuTimelineDiaryStack.ApiUrl = https://xxxxxx.execute-api.ap-northeast-1.amazonaws.com
KakuyasuTimelineDiaryStack.UserPoolId = ap-northeast-1_xxxxxxxx
KakuyasuTimelineDiaryStack.UserPoolClientId = xxxxxxxxxxxxxxxxxxxxxxxxxx
```

1.  上記URLをコピー。
    
2.  `web-app/.env.example` を `web-app/.env` にコピーして貼り付け。
    
    コード スニペット
    
    ```
    # ※末尾に / を付けない（`.../items` のようにコード側でパスを連結します）
    VITE_API_URL=https://xxxxxx.execute-api.ap-northeast-1.amazonaws.com
    VITE_USER_POOL_ID=ap-northeast-1_xxxxxxxx
    VITE_USER_POOL_CLIENT_ID=xxxxxxxxxxxxxxxxxxxxxxxxxx
    ```

3. （初回のみ）Cognitoにログインユーザーを作成する  
   本スタックはセルフサインアップ無効（管理者作成のみ）です。AWSコンソールから `UserPoolId` のユーザープールを開き、ユーザーを作成してください。


### Step 3: 正しいURLでアプリを焼き固める（ビルド）

`.env` の情報（APIの接続先）をアプリに読み込ませて、公開用の資材を作ります。

Bash

```
cd ../web-app
npm install  # 初回のみ
npm run build
```

※ これで `web-app/dist` フォルダが生成されます。

### Step 4: 完成品を配送する（2回目のデプロイ）

完成した `dist` フォルダをS3にアップロードし、CloudFrontと連携させます。

Bash

```
cd ../gekiyasu-diary-cdk-py
cdk deploy

# IAM変更の確認プロンプトを省略したい場合
# cdk deploy --require-approval never
```

最後に表示される `CloudFrontUrl` にアクセスすれば、あなたのアプリが世界に公開されています！

* * *

## 🔄 【日常】開発・変更時の手順

2回目以降は、`.env` のURLは変わらないので、もっとシンプルです。

### パターンA：フロントエンド（React）の修正

「画面のデザインを変えたい」「新機能を追加したい」場合。

1.  コードを修正する。
    
2.  **ビルドする：** `cd web-app && npm run build`
    
3.  **デプロイする：** `cd ../gekiyasu-diary-cdk-py && cdk deploy`
    

> **💡 激安時短テクニック** フロントエンドの変更のみで、いちいちCDKの確認を待つのが面倒な場合は、AWS CLIでS3へ直接同期すると爆速です。
> 
> Bash
> 
> ```
> aws s3 sync web-app/dist/ s3://バケット名 --delete
> ```
>
> ※バケット名は CloudFormation のスタック（`KakuyasuTimelineDiaryStack`）→「リソース」→ `WebsiteBucket` から確認できます。
> 
> ※反映されない場合はCloudFrontのコンソールから「Invalidation（キャッシュ削除）」を行ってください。

### パターンB：バックエンド（Python）の修正

「データの保存項目を増やしたい」「計算ロジックを変えたい」場合。

1.  `lambda/app.py` を修正する。
    
2.  **デプロイする：** `cd gekiyasu-diary-cdk-py && cdk deploy` ※ Reactの再ビルド（npm run build）は不要です！
    

* * *

## ⚠️ 注意点：もしAPIを作り直したら？

もし `cdk destroy` で環境を完全に削除して作り直した場合、**APIのURLが変わってしまいます。** その際は、**「Step 2〜4」** をもう一度行い、新しいURLをアプリに焼き直して（ビルドして）からデプロイしてください。

## ⚠️ 注意点：`cdk destroy` はデータも消えます

このスタックは `RemovalPolicy.DESTROY` を使用しているため、`cdk destroy` を実行すると DynamoDB / Cognito なども削除され、保存済みデータが失われます。

## 🔎 よくある詰まりどころ

- `Please run 'cdk bootstrap'` と出る：Step 0 をアカウント/リージョンごとに実行
- 画面が更新されない：CloudFront のキャッシュ反映に数分かかる場合があります（急ぐ場合は Invalidation）
